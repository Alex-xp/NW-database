<!DOCTYPE html>
<!--
ДАННЫЙ ФАЙЛ ДОЛЖЕН БЫТЬ РАСПОЛОЖЕН В ДИРЕКТОРИИ ПРОЕКТА
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div>ПРИМЕР РАБОТЫ С SQLITE</div>


        <script>
            
            /*
             * В данном модуле имеется возможность создания запросов при помощи конструктора запросов
             * Конструктор - не обязателен, но позволяет облегчить создание сложных запросов.
             * Можно использовать модуль с чистым sql, так и совмесно с конструктором.
             * 
             * (для простых запросов конструктор может создать много ненужного кода, 
             * а сложные запросы легче разбивать и читать код)
             * 
             */ 

            // Подключение модуля
            var DB = require('../node_modules/sqlite/sqlite.js');
			
			// Модуль выполняется в режиме отладки (debug) с выводом сообщений об ошибках в sql запросах через alert("ОШИБКА SQL").
			// Для отключения режима debug - установите DB.debug = false
			// Ошибки последнего запроса можете смотреть черес строку DB.ErrorMsg в любом случае.
			DB.debug = true;
			
            // получить версию модуля (версия откомпилированного node бинарника)
            alert(DB.Version());

            // посмотреть модуль в консоле
            console.log(DB);

            // Установить соединение ***************************************************************
            if (DB.Connect("my_db_file.db")) {
                alert("Соединение установлено");

                // СОЗДАНИЕ ТАБЛИЦ *****************************************************************
                // Запрос на создание таблицы tab1 (PRIMARY KEY ASC - автонумерация)
                if (DB.Exec("CREATE TABLE IF NOT EXISTS tab1(x INTEGER PRIMARY KEY ASC, y, z);")) {
                    alert("ЗАПРОС ВЫПОЛНЕН");
                }
                
                // Тот же запрос, но с использованием конструктора запросов (таблица tab2)
                
                if(new DB.SQL().table("tab2").create([
                        new DB.FIELD({"name":"x", "type":DB.F_INT + DB.F_PK + DB.F_ASC}),
                        new DB.FIELD({"name":"y"}),
                        new DB.FIELD({"name":"z"})
                    ], true).exec()){
                        alert("ЗАПРОС ВЫПОЛНЕН");
                    }
                
                /*
                 * Конструктор запросов вызывается через new DB.SQL()
                 * Создается новый объект конструктора
                 * 
                 * Первым делом в конструкторе необходимо указать таблицу
                 * new DB.SQL().table("tab2")
                 * ( можно указать набор таблиц для сложных запросов в виде массива DB.tables(["tab1", "tab2"]) )
                 * 
                 * Далее строим запрос по своему требованию (create, select, update)
                 * DB.SQL().table("tab2").create(.......);
                 * 
                 * И в конце выполняем запрос exec() (вернет true, false или результат)
                 * DB.SQL().table("tab2").create(.......).exec();
                 * 
                 * 
                 * В create можно передать строку SQL в чистом виде на создание полей
                 * x INTEGER PRIMARY KEY ASC, y, z
                 * 
                 * или использовать конструкторы полей
                 * new DB.FIELD({"name":"имя_поля_eng", "type":"тип_поля"});
                 * 
                 * name - имя - обязательный параметр
                 * 
                 * type - типы полей (определяются сложением по правилам SQL запросов):
                 *      DB.F_TEXT = "TEXT ";
                 *      DB.F_INT = "INTEGER ";
                 *      DB.F_PK = "PRIMARY KEY ";
                 *      DB.F_NUM = "NUMERIC ";
                 *      DB.F_FLOAT = "REAL ";
                 *      DB.F_UNIQUE = "UNIQUE ";
                 *      DB.F_NONE = "NONE ";
                 *      DB.F_ASC = "ASC ";
                 *      DB.F_DESC = "DESC ";
                 *      DB.F_NOT_NULL = "NOT NULL ";
                 * (типы можно не указывать - sqlite позволяет работать с полями без указания их типов)
                 * 
                 * Последний параметр в create(SQL_DATA, EXITS) устанавливает проверку IF NOT EXISTS
                 * Если нужна проверка - установите параметр в true
                 * При этом параметре - запрос будет выполнен без ошибок и вернется значение true
                 * (ПРИ СОЗДАНИИ ТАБЛИЦ БУДТЕ ВНИМАТЕЛЬНЫ С ПОСЛЕДНИМ ПАРАМЕТРОМ И ВОЗВРАЩАЕМЫМ РЕЗУЛЬТАТОМ)
                 */
                
                // УДАЛИМ ТАБЛИЦУ tab2 ************************************************************************
                if(DB.Exec("DROP TABLE IF EXISTS tab2")){
                    alert("ЗАПРОС ВЫПОЛНЕН");
                };
                // При помощи конструктора запросов
                if(new DB.SQL().drop_table("tab2", true).exec()){
                    alert("ЗАПРОС ВЫПОЛНЕН");
                };
                /*
                 * drop_table(table, exits) - удаляет таблицу
                 * table - имя удаляемой таблицы (обязательно)
                 * exits - true - добавляет проверку IF EXISTS
                 */
                
                // ДОБАВИМ ЗАПИСЬ В СУЩЕСТВУЮЩУЮ ТАБЛИЦУ tab1 *************************************************
                
                if(DB.Exec("INSERT INTO tab1 (y,z) VALUES('xy','xz')")){
                    alert("ЗАПРОС ВЫПОЛНЕН");
                };
                
                // добавление данных при помощи конструктора запросов (2 способа создания запроса и реализация)
                // вывод объекта SQL конструктора
                console.log(new DB.SQL().insert("INSERT INTO tab1 (y,z) VALUES('xy','xz')")); // при помощи SQL
                console.log(new DB.SQL().table("tab1").insert({"y":"dp1","z":"dp2"})); // в конструкторе
                
				// реализация полного запроса в конструкторе
                if(new DB.SQL().table("tab1").insert({"y":"dp1","z":"dp2"}).exec()){
                    alert("ЗАПРОС ВЫПОЛНЕН");
                };
                
                // ВЫБОРКА ДАННЫХ SELECT **********************************************************************
                
                /*
                 * При выборке данных - возвращается объект результата выборки:
                 *      filelds_count - количество полей в результате (столбцов)
                 *      rows_count - количество результирующих записей (строк)
                 *      fields_names - массив с именами полей (столбцов)
                 *      getFName(x) - получить имя поля (столбца) по индексу
                 *      result - массив результата (результат[индекс_строки][имя_поля])
                 *      get(y,x) - получить данные по индексу строки и индексу поля
                 *      getForName(y,f_name) - получить данные по индексу строки и имени поля
                 */
				 // если результат == false - ошибка в запросе
                
                // получаем все поля таблицы tab1
                console.log(DB.Query("SELECT * FROM tab1"));
                
                // тот же запрос в конструкторе ( в select передаем массив полей для выборки )
                console.log(new DB.SQL().table("tab1").select(["*"]).exec());
                
                // или
                console.log(new DB.SQL().table("tab1").select(["x", "y", "z"]).exec());
				
				
				// УСЛОВИЕ ЗАПРОСА WHERE **********************************************************************
                /*
                 * Если условие запроса написно в SQL, действие очень простое
                 * DB.Query("SELECT * FROM tab1 WHERE x=1");
                 * или при помощи SQL в конструкторе
                 * new DB.SQL().table("tab1").select(["*"]).where("x=1 AND ... OR .... ").exec();
                 * 
				 * МОЖНО КОНСТРУИРОВАТЬ И САМО УСЛОВИЕ
                 * При конструировании условия:
                 * Создаем объект условия:
                 *      var wh = new DB.WHERE("x=1")
                 * 
                 * к объекту условия - можно добавлять данные и группировать их
                 * пример: wh.AND("y='xy'");
                 *      
                 * типы групировки:
                 *      AND(условие) OR(условие) XOR(условие) - добавляет последовательность типа - AND условие
                 *      add(строка) - добавляет произвольную строку в запрос
                 *      insAND(WHERE_OBJ) insOR(WHERE_OBJ) insXOR(WHERE_OBJ) - встраивает в скобки запрос
                 */
                
                console.log(DB.Query("SELECT * FROM tab1 WHERE x=1 AND(y='xy' AND z='xz')"));
                
                var WH0 = new DB.WHERE("y='xy'").AND("z='zx'"); // внутренняя вставка
                var WH = new DB.WHERE("x=1").insAND(WH0); 
                console.log(new DB.SQL().table("tab1").select(["*"]).where(WH).exec());
                
                // ЗАПИСЬ ПРОЩЕ ДЛЯ ЧТЕНИЯ (в этом и заключаются плюсы конструктора)
                console.log(
                        new DB.SQL()
                            .table("tab1")
                            .select(["*"])
                            .where(
                                new DB.WHERE("x=1")
                                    .insAND(
                                        new DB.WHERE("y='xy'")
                                            .AND("z='xz'")
                                    )
                            )
                            .exec()
                        );
                
                
				// ОБНОВЛЕНИЕ ДАННЫХ В ТАБЛИЦЕ ***************************************************************
                
                DB.Exec("UPDATE tab1 SET y='UPD_Y' WHERE x=2");
                console.log(DB.Query("SELECT * FROM tab1 WHERE x=2"));
                
                /*
                 * В конструкторе обновление создается функцией update(upd_obj)
                 * upd_obj = {"поле":"данные", "поле2":"данные2", ..... }
                 */
                
                var r = new DB.SQL().table("tab1").update({"y":"CONST_UPDATE_YY"}).where("x=2").exec();
                console.log(new DB.SQL().table("tab1").select("*").where("x=2").exec());
				
				
				// В ДАННОМ МОДУЛЕ ПРЕДУСМОТРЕНО ПОЛУЧЕНИЕ СПИСКА ТАБЛИЦ БАЗЫ DB.GetTablesDB()
				console.log(DB.GetTablesDB());
				
                
            } else {
                alert("СОЕДИНЕНИЕ НЕ УСТАНОВЛЕНО!!!");
            }




        </script>




    </body>
</html>
